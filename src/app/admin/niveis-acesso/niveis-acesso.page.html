<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      <ion-icon name="shield-outline"></ion-icon>
      Gerenciar Níveis de Acesso
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Níveis de Acesso</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Barra de Pesquisa -->
  <ion-searchbar
    [(ngModel)]="searchTerm"
    (ionInput)="onSearchChange($event)"
    placeholder="Pesquisar níveis..."
    show-clear-button="focus">
  </ion-searchbar>

  <!-- Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading -->
  <div *ngIf="loading && niveis.length === 0" class="ion-padding">
    <ion-skeleton-text animated style="width: 100%; height: 100px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 80%; height: 100px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 90%; height: 100px;"></ion-skeleton-text>
  </div>

  <!-- Lista de Níveis -->
  <ion-grid *ngIf="!loading || niveis.length > 0">
    <ion-row>
      <ion-col size="12" size-md="6" size-lg="4" *ngFor="let nivel of niveisFiltrados">
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-chip [style.background-color]="getCorNivel(nivel.cor)" color="light">
                <ion-icon name="shield-outline"></ion-icon>
                <ion-label>{{ nivel.nome }}</ion-label>
              </ion-chip>
            </ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <p>{{ nivel.descricao || 'Sem descrição' }}</p>

            <div class="nivel-info">
              <ion-item lines="none">
                <ion-icon name="people-outline" slot="start"></ion-icon>
                <ion-label>Usuários</ion-label>
                <ion-badge slot="end" color="primary">{{ nivel.total_usuarios }}</ion-badge>
              </ion-item>

              <ion-item lines="none">
                <ion-icon name="list-outline" slot="start"></ion-icon>
                <ion-label>Ordem</ion-label>
                <ion-badge slot="end" color="medium">{{ nivel.ordem }}</ion-badge>
              </ion-item>

              <ion-item lines="none">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                <ion-label>Status</ion-label>
                <ion-badge slot="end" [color]="getStatusColor(nivel.ativo)">
                  {{ getStatusNivel(nivel.ativo) }}
                </ion-badge>
              </ion-item>
            </div>

            <div class="nivel-actions" *ngIf="canEdit()">
              <ion-button
                fill="clear"
                size="small"
                (click)="abrirModalEditar(nivel)">
                <ion-icon name="create-outline"></ion-icon>
                Editar
              </ion-button>

              <ion-button
                fill="clear"
                size="small"
                color="primary"
                (click)="editarPermissoes(nivel)">
                <ion-icon name="shield-outline"></ion-icon>
                Permissões
              </ion-button>

              <ion-button
                fill="clear"
                size="small"
                color="danger"
                (click)="excluirNivel(nivel)"
                [disabled]="nivel.total_usuarios > 0">
                <ion-icon name="trash-outline"></ion-icon>
                Excluir
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Mensagem quando não há níveis -->
  <div *ngIf="!loading && niveisFiltrados.length === 0" class="ion-padding ion-text-center">
    <ion-icon name="shield-outline" size="large" color="medium"></ion-icon>
    <h3>Nenhum nível encontrado</h3>
    <p *ngIf="searchTerm">Tente ajustar sua pesquisa</p>
    <p *ngIf="!searchTerm">Crie seu primeiro nível de acesso</p>
  </div>

  <!-- FAB para criar novo nível -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="canEdit()">
    <ion-fab-button (click)="abrirModalCriar()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal de Criação/Edição -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="fecharModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            {{ isEditMode ? 'Editar Nível' : 'Novo Nível' }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="fecharModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <form (ngSubmit)="salvarNivel()">
          <ion-list>
            <!-- Nome -->
            <ion-item>
              <ion-label position="stacked">Nome *</ion-label>
              <ion-input
                [(ngModel)]="formData.nome"
                name="nome"
                placeholder="Ex: Supervisor"
                required>
              </ion-input>
            </ion-item>

            <!-- Descrição -->
            <ion-item>
              <ion-label position="stacked">Descrição</ion-label>
              <ion-textarea
                [(ngModel)]="formData.descricao"
                name="descricao"
                placeholder="Descreva as responsabilidades deste nível"
                rows="3">
              </ion-textarea>
            </ion-item>

            <!-- Cor -->
            <ion-item>
              <ion-label position="stacked">Cor</ion-label>
              <ion-select [(ngModel)]="formData.cor" name="cor">
                <ion-select-option
                  *ngFor="let cor of coresDisponiveis"
                  [value]="cor">
                  <div class="cor-option">
                    <div class="cor-preview" [style.background-color]="cor"></div>
                    {{ cor }}
                  </div>
                </ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Ordem -->
            <ion-item>
              <ion-label position="stacked">Ordem de Exibição</ion-label>
              <ion-range
                [(ngModel)]="formData.ordem"
                name="ordem"
                min="0"
                max="100"
                step="1"
                pin="true">
                <ion-label slot="start">0</ion-label>
                <ion-label slot="end">100</ion-label>
              </ion-range>
            </ion-item>

            <!-- Status -->
            <ion-item>
              <ion-label>Ativo</ion-label>
              <ion-toggle
                [(ngModel)]="formData.ativo"
                name="ativo"
                slot="end">
              </ion-toggle>
            </ion-item>
          </ion-list>

          <div class="ion-padding">
            <ion-button
              expand="block"
              type="submit"
              [disabled]="!formData.nome.trim() || loading">
              <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
              <ion-icon *ngIf="!loading" name="save-outline" slot="start"></ion-icon>
              {{ isEditMode ? 'Atualizar' : 'Criar' }} Nível
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>

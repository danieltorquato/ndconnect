<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      <ion-icon name="shield-outline"></ion-icon>
      Permissões - {{ nivel?.nome }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Permissões</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Barra de Pesquisa e Filtros -->
  <div class="filters-section">
    <ion-searchbar
      [(ngModel)]="searchTerm"
      (ionInput)="onSearchChange($event)"
      placeholder="Pesquisar páginas..."
      show-clear-button="focus">
    </ion-searchbar>

    <ion-segment [(ngModel)]="categoriaFiltro" (ionChange)="onCategoriaChange($event)">
      <ion-segment-button value="todas">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
      <ion-segment-button *ngFor="let categoria of categorias" [value]="categoria">
        <ion-label>{{ categoria }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading -->
  <div *ngIf="loading" class="ion-padding">
    <ion-skeleton-text animated style="width: 100%; height: 100px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 80%; height: 100px;"></ion-skeleton-text>
    <ion-skeleton-text animated style="width: 90%; height: 100px;"></ion-skeleton-text>
  </div>

  <!-- Lista de Permissões por Categoria -->
  <div *ngIf="!loading">
    <div *ngFor="let categoria of getCategoriasFiltradas()" class="categoria-section">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <div class="categoria-header">
              <div>
                <ion-icon name="folder-outline"></ion-icon>
                {{ categoria }}
                <ion-badge color="primary">
                  {{ getPermissoesAtivasCategoria(categoria) }}/{{ getTotalPermissoesCategoria(categoria) }}
                </ion-badge>
              </div>
              <div class="categoria-actions" *ngIf="canEdit()">
                <ion-button
                  fill="clear"
                  size="small"
                  (click)="selecionarTodasPermissoes(categoria)">
                  <ion-icon name="checkmark-outline"></ion-icon>
                  Todas
                </ion-button>
                <ion-button
                  fill="clear"
                  size="small"
                  color="danger"
                  (click)="removerTodasPermissoes(categoria)">
                  <ion-icon name="close-outline"></ion-icon>
                  Nenhuma
                </ion-button>
              </div>
            </div>
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let permissao of getPermissoesPorCategoria(categoria)"
                      lines="inset">
              <ion-icon [name]="permissao.icone" slot="start" [color]="getPermissaoAtual(permissao, 'pode_acessar') ? 'primary' : 'medium'"></ion-icon>

              <ion-label>
                <h3>{{ permissao.nome }}</h3>
                <p>{{ permissao.descricao || permissao.rota }}</p>
              </ion-label>

              <div class="permissao-toggles" slot="end" *ngIf="canEdit()">
                <ion-toggle
                  [checked]="getPermissaoAtual(permissao, 'pode_acessar')"
                  (ionChange)="onPermissaoChange(permissao, 'pode_acessar', $event.detail.checked)"
                  color="primary">
                </ion-toggle>

                <ion-toggle
                  [checked]="getPermissaoAtual(permissao, 'pode_editar')"
                  (ionChange)="onPermissaoChange(permissao, 'pode_editar', $event.detail.checked)"
                  color="warning"
                  [disabled]="!getPermissaoAtual(permissao, 'pode_acessar')">
                </ion-toggle>

                <ion-toggle
                  [checked]="getPermissaoAtual(permissao, 'pode_deletar')"
                  (ionChange)="onPermissaoChange(permissao, 'pode_deletar', $event.detail.checked)"
                  color="danger"
                  [disabled]="!getPermissaoAtual(permissao, 'pode_acessar')">
                </ion-toggle>

                <ion-toggle
                  [checked]="getPermissaoAtual(permissao, 'pode_criar')"
                  (ionChange)="onPermissaoChange(permissao, 'pode_criar', $event.detail.checked)"
                  color="success"
                  [disabled]="!getPermissaoAtual(permissao, 'pode_acessar')">
                </ion-toggle>
              </div>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Mensagem quando não há permissões -->
  <div *ngIf="!loading && permissoesFiltradas.length === 0" class="ion-padding ion-text-center">
    <ion-icon name="shield-outline" size="large" color="medium"></ion-icon>
    <h3>Nenhuma permissão encontrada</h3>
    <p *ngIf="searchTerm">Tente ajustar sua pesquisa</p>
    <p *ngIf="!searchTerm">Não há páginas cadastradas no sistema</p>
  </div>

  <!-- Botão de Salvar (Floating) -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="canEdit() && temModificacoes()">
    <ion-fab-button (click)="salvarPermissoes()" [disabled]="saving">
      <ion-spinner *ngIf="saving" name="crescent"></ion-spinner>
      <ion-icon *ngIf="!saving" name="save-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Barra de Ações Fixa -->
  <div class="actions-bar" *ngIf="canEdit() && temModificacoes()">
    <ion-button
      expand="block"
      (click)="salvarPermissoes()"
      [disabled]="saving">
      <ion-spinner *ngIf="saving" name="crescent"></ion-spinner>
      <ion-icon *ngIf="!saving" name="save-outline" slot="start"></ion-icon>
      Salvar Alterações
    </ion-button>
  </div>
</ion-content>
